import{r as l,j as e,I as F,T as ge,a as pe,b as fe,O as be}from"./index-CSOEl8am.js";import{M as xe}from"./Modal--D-Dtxk0.js";const ye=[{label:"L",value:"1"},{label:"M",value:"2"},{label:"M",value:"3"},{label:"J",value:"4"},{label:"V",value:"5"},{label:"S",value:"6"},{label:"D",value:"0"}],je=({isOpen:s,onClose:x,onSave:h,onDelete:w,task:n,selectedDate:v,users:N,editMode:u,isSaving:b,allTasks:k})=>{const[y,p]=l.useState(""),[S,C]=l.useState(""),[i,g]=l.useState("08"),[r,c]=l.useState("00"),[a,o]=l.useState("AM"),[d,f]=l.useState("30"),[E,L]=l.useState("pre-apertura"),[A,P]=l.useState(""),[O,D]=l.useState(!1),[M,T]=l.useState("once"),[z,U]=l.useState([]),[Y,ae]=l.useState("4"),[G,J]=l.useState([]),[Z,Q]=l.useState(""),[ne,re]=l.useState(v);l.useEffect(()=>{if(s){const t=N.length>0?N[0].name:"";p((n==null?void 0:n.text)||""),C((n==null?void 0:n.employee)||t),re((n==null?void 0:n.date)||v);const m=(n==null?void 0:n.time)||"08:00",[H,R]=m.split(":").map(Number),oe=H>=12?"PM":"AM";let _=H%12;if(_===0&&(_=12),g(String(_).padStart(2,"0")),c(String(R).padStart(2,"0")),o(oe),f(String((n==null?void 0:n.duration)||"30")),L((n==null?void 0:n.shift)||"pre-apertura"),P((n==null?void 0:n.zone)||""),D((n==null?void 0:n.isCritical)||!1),J((n==null?void 0:n.subtasks)||[]),Q(""),n&&u==="future"&&n.recurrenceId){T("weekly");const j=k.filter($=>$.recurrenceId===n.recurrenceId),X=new Set;j.forEach($=>{const W=new Date($.date);W.setMinutes(W.getMinutes()+W.getTimezoneOffset());const q=W.getDay();X.add(String(q))}),U(Array.from(X))}else T("once"),U([]);ae("4")}},[s,n,N,v,u,k]);const ie=t=>{U(m=>m.includes(t)?m.filter(H=>H!==t):[...m,t])},le=()=>{if(Z.trim()==="")return;const t={id:`sub-${Date.now()}`,text:Z.trim(),isCompleted:!1};J([...G,t]),Q("")},ce=t=>{t.key==="Enter"&&(t.preventDefault(),le())},V=t=>{J(G.filter(m=>m.id!==t))},de=t=>{if(t.preventDefault(),!y){alert("Por favor completa el nombre de la tarea.");return}if(M==="weekly"&&z.length===0&&u!=="single"){alert("Por favor selecciona al menos un día para la tarea recurrente.");return}let m=parseInt(i,10);a==="PM"&&m!==12?m+=12:a==="AM"&&m===12&&(m=0);const H=`${String(m).padStart(2,"0")}:${r}`,R={text:y,employee:S,time:H,duration:parseInt(d,10),shift:E,zone:A,isCritical:O,date:ne,recurrence:M,selectedDays:z,recurrenceWeeks:Y,subtasks:G};h(R,n==null?void 0:n.id)},ee=()=>{n&&w(n)},te=!!n;return e.jsx(xe,{isOpen:s,onClose:b?()=>{}:x,title:n?"Editar Tarea":"Añadir Nueva Tarea",children:e.jsxs("form",{onSubmit:de,className:"flex flex-col gap-4 max-h-[80vh] overflow-y-auto pr-2",children:[e.jsxs("fieldset",{disabled:b,children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"text-sm font-medium text-gray-600",children:"Nombre de la Tarea"}),e.jsx("input",{type:"text",value:y,onChange:t=>p(t.target.value),required:!0,className:"w-full p-2 border border-gray-300 rounded-md bg-gray-50"})]}),u==="single"&&e.jsxs("div",{className:"form-group mt-4",children:[e.jsx("label",{className:"text-sm font-medium text-gray-600",children:"Fecha"}),e.jsx("input",{type:"date",value:ne,onChange:t=>re(t.target.value),className:"w-full p-2 border border-gray-300 rounded-md bg-gray-50"})]}),e.jsxs("fieldset",{disabled:te&&u!=="future",className:"mt-4",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"text-sm font-medium text-gray-600 mb-2 block",children:"Repetición"}),e.jsxs("div",{className:"flex gap-2 bg-gray-200 rounded-lg p-1",children:[e.jsx("button",{type:"button",onClick:()=>T("once"),className:`flex-1 p-2 rounded-md text-sm font-bold transition-colors ${M==="once"?"bg-white shadow-sm":""}`,children:"Una vez"}),e.jsx("button",{type:"button",onClick:()=>T("weekly"),className:`flex-1 p-2 rounded-md text-sm font-bold transition-colors ${M==="weekly"?"bg-white shadow-sm":""}`,children:"Semanalmente"})]}),te&&u==="single"&&e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"La repetición no se puede cambiar al editar una sola instancia."}),te&&u==="future"&&e.jsxs("div",{className:"mt-2 p-3 bg-yellow-50 border-l-4 border-yellow-400 text-yellow-800 text-sm rounded-r-lg flex items-start gap-3",children:[e.jsx(F,{name:"alert-triangle",size:20,className:"flex-shrink-0 mt-0.5"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-bold",children:"Atención"}),e.jsx("p",{children:"Cambiar la repetición reemplazará todas las futuras tareas de esta serie con un nuevo patrón."})]})]})]}),M==="weekly"&&e.jsxs("div",{className:"flex flex-col gap-4 mt-4",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"text-sm font-medium text-gray-600 mb-2 block",children:"Días de la semana"}),e.jsx("div",{className:"flex justify-between gap-1",children:ye.map(({label:t,value:m})=>e.jsx("button",{type:"button",onClick:()=>ie(m),className:`w-9 h-9 flex items-center justify-center font-bold rounded-full border-2 transition-colors ${z.includes(m)?"bg-blue-600 text-white border-blue-600":"bg-gray-100 border-gray-300"}`,children:t},m))})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"text-sm font-medium text-gray-600",children:"Repetir durante"}),e.jsxs("select",{value:Y,onChange:t=>ae(t.target.value),className:"w-full p-2 border border-gray-300 rounded-md bg-gray-50",children:[e.jsx("option",{value:"4",children:"4 semanas"}),e.jsx("option",{value:"8",children:"8 semanas"}),e.jsx("option",{value:"12",children:"12 semanas"})]})]})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 mt-4",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"text-sm font-medium text-gray-600",children:"Empleado"}),e.jsx("select",{value:S,onChange:t=>C(t.target.value),className:"w-full p-2 border border-gray-300 rounded-md bg-gray-50",children:N.map(t=>e.jsx("option",{value:t.name,children:t.name},t.id))})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"text-sm font-medium text-gray-600",children:"Turno"}),e.jsxs("select",{value:E,onChange:t=>L(t.target.value),className:"w-full p-2 border border-gray-300 rounded-md bg-gray-50",children:[e.jsx("option",{value:"matutino",children:"Matutino"}),e.jsx("option",{value:"pre-apertura",children:"Pre Apertura"}),e.jsx("option",{value:"cierre",children:"Cierre"}),e.jsx("option",{value:"default",children:"Otro"})]})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 mt-4",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"text-sm font-medium text-gray-600",children:"Hora"}),e.jsxs("div",{className:"flex gap-1",children:[e.jsx("select",{value:i,onChange:t=>g(t.target.value),className:"w-full p-2 border border-gray-300 rounded-md bg-gray-50",children:Array.from({length:12},(t,m)=>m+1).map(t=>e.jsx("option",{value:String(t).padStart(2,"0"),children:String(t).padStart(2,"0")},t))}),e.jsx("select",{value:r,onChange:t=>c(t.target.value),className:"w-full p-2 border border-gray-300 rounded-md bg-gray-50",children:Array.from({length:60},(t,m)=>m).map(t=>e.jsx("option",{value:String(t).padStart(2,"0"),children:String(t).padStart(2,"0")},t))}),e.jsxs("select",{value:a,onChange:t=>o(t.target.value),className:"w-full p-2 border border-gray-300 rounded-md bg-gray-50",children:[e.jsx("option",{children:"AM"}),e.jsx("option",{children:"PM"})]})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"text-sm font-medium text-gray-600",children:"Duración"}),e.jsx("select",{value:d,onChange:t=>f(t.target.value),required:!0,className:"w-full p-2 border border-gray-300 rounded-md bg-gray-50",children:ge.map(t=>e.jsx("option",{value:t.value,children:t.label},t.value))})]})]}),e.jsxs("div",{className:"form-group mt-4",children:[e.jsx("label",{className:"text-sm font-medium text-gray-600",children:"Zona (Opcional)"}),e.jsx("input",{type:"text",value:A,onChange:t=>P(t.target.value),className:"w-full p-2 border border-gray-300 rounded-md bg-gray-50"})]}),e.jsxs("div",{className:"form-group mt-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-600 mb-2 block",children:"Subtareas"}),e.jsxs("div",{className:"bg-gray-100 p-3 rounded-lg",children:[G.length>0&&e.jsx("ul",{className:"space-y-2 mb-3",children:G.map(t=>e.jsxs("li",{className:"flex items-center justify-between bg-white p-2 rounded",children:[e.jsx("span",{className:"text-sm text-gray-700",children:t.text}),e.jsx("button",{type:"button",onClick:()=>V(t.id),className:"p-1 text-gray-400 hover:text-red-600",children:e.jsx(F,{name:"trash-2",size:16})})]},t.id))}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{type:"text",value:Z,onChange:t=>Q(t.target.value),onKeyDown:ce,placeholder:"Añadir una subtarea...",className:"w-full p-2 border border-gray-300 rounded-md bg-white text-sm"}),e.jsx("button",{type:"button",onClick:le,className:"py-2 px-4 bg-blue-500 text-white font-semibold rounded-lg hover:bg-blue-600 text-sm",children:"Añadir"})]})]})]}),e.jsxs("div",{className:"flex items-center gap-2 mt-2",children:[e.jsx("input",{type:"checkbox",id:"task-critical",checked:O,onChange:t=>D(t.target.checked),className:"w-4 h-4"}),e.jsx("label",{htmlFor:"task-critical",className:"text-sm font-medium text-gray-600",children:"Es una tarea crítica"})]})]}),e.jsxs("div",{className:"flex justify-between items-center mt-4 pt-4 border-t sticky bottom-0 bg-white",children:[e.jsx("div",{children:n&&e.jsx("button",{type:"button",onClick:ee,disabled:b,className:"py-2 px-4 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 disabled:bg-red-400",children:"Eliminar Tarea"})}),e.jsxs("div",{className:"flex gap-4",children:[e.jsx("button",{type:"button",onClick:x,disabled:b,className:"py-2 px-4 bg-gray-200 text-gray-800 font-semibold rounded-lg hover:bg-gray-300 disabled:bg-gray-300",children:"Cancelar"}),e.jsx("button",{type:"submit",disabled:b,className:"py-2 px-4 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 w-36 flex items-center justify-center disabled:bg-blue-400",children:b?e.jsxs(e.Fragment,{children:[e.jsx(F,{name:"refresh-cw",className:"animate-spin mr-2",size:16}),"Guardando..."]}):"Guardar Cambios"})]})]})]})})},ve=({selectedDate:s,setSelectedDate:x})=>{const[h,w]=l.useState(s),[n,v]=l.useState(""),N=l.useRef(0);l.useEffect(()=>{w(s)},[s]),l.useEffect(()=>{if(n.startsWith("slide-out")){const a=n.includes("left")?"next":"prev",o=setTimeout(()=>{const d=new Date(h);d.setDate(d.getDate()+(a==="prev"?-7:7)),w(d);const f=new Date(s);f.setDate(f.getDate()+(a==="prev"?-7:7)),x(f),v(a==="next"?"slide-in-from-right":"slide-in-from-left")},200);return()=>clearTimeout(o)}else if(n.startsWith("slide-in")){const a=setTimeout(()=>{v("")},200);return()=>clearTimeout(a)}},[n,h,s,x]);const u=a=>{n||v(a==="next"?"slide-out-left":"slide-out-right")},b=a=>{const o=a.target.value;if(o){const d=new Date(o);d.setMinutes(d.getMinutes()+d.getTimezoneOffset()),x(d)}},k=a=>{N.current=a.targetTouches[0].clientX},y=a=>{const o=a.changedTouches[0].clientX,d=50,f=N.current-o;f>d?u("next"):f<-d&&u("prev")},p=new Date;p.setHours(0,0,0,0);const S=new Date(h),C=h.getDay(),i=h.getDate()-C+(C===0?-6:1);S.setDate(i),S.setHours(0,0,0,0);const g=[];for(let a=0;a<7;a++){const o=new Date(S);o.setDate(S.getDate()+a),g.push(o)}const r=(a,o)=>a.getFullYear()===o.getFullYear()&&a.getMonth()===o.getMonth()&&a.getDate()===o.getDate(),c=h.toLocaleDateString("es-ES",{month:"long",year:"numeric"});return e.jsxs("div",{className:"w-full",children:[e.jsxs("div",{className:"flex justify-between items-center mb-2 px-2",children:[e.jsx("button",{onClick:()=>u("prev"),className:"p-2 text-gray-500 hover:text-blue-600 rounded-full hover:bg-gray-100 transition-colors",children:e.jsx(F,{name:"chevron-left",size:20})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("h4",{className:"font-bold text-gray-700 capitalize text-sm",children:c}),e.jsxs("div",{className:"relative w-9 h-9 flex items-center justify-center text-gray-500 hover:text-blue-600 rounded-full hover:bg-gray-100 transition-colors cursor-pointer",title:"Seleccionar fecha",children:[e.jsx(F,{name:"calendar",size:18}),e.jsx("input",{type:"date",onChange:b,className:"absolute inset-0 w-full h-full opacity-0 cursor-pointer","aria-label":"Seleccionar fecha"})]})]}),e.jsx("button",{onClick:()=>u("next"),className:"p-2 text-gray-500 hover:text-blue-600 rounded-full hover:bg-gray-100 transition-colors",children:e.jsx(F,{name:"chevron-right",size:20})})]}),e.jsx("div",{className:"p-1 bg-gray-200 rounded-lg overflow-hidden relative touch-pan-y",children:e.jsx("div",{className:`flex justify-between items-center gap-1 md:gap-2 ${n}`,onTouchStart:k,onTouchEnd:y,children:g.map(a=>{const o=r(a,s),d=r(a,p);return e.jsx("button",{onClick:()=>x(a),className:"px-1 py-1 md:px-2 md:py-2 rounded-md transition-all duration-200 text-center flex-1",children:e.jsxs("div",{className:`${o?"bg-white shadow-sm rounded-md":""} py-1`,children:[e.jsx("span",{className:`text-xs uppercase font-bold ${o?"text-blue-600":"text-gray-500"}`,children:a.toLocaleDateString("es-ES",{weekday:"short"}).replace(".","")}),e.jsx("p",{className:`font-bold text-lg ${d?"text-blue-600":o?"text-gray-800":"text-gray-600"}`,children:a.getDate()})]})},a.toISOString())})})})]})},Ne=s=>{switch(s){case"inprogress":return"opacity-100 animate-pulse-yellow";case"done":return"opacity-50";case"todo":default:return"opacity-100"}},we=({task:s,onUpdateStatus:x,onEdit:h,onViewSubtasks:w,style:n,userColor:v})=>{var g,r;const N=Ne(s.status),u=c=>{c.stopPropagation(),s.status==="todo"?x(s.id,"inprogress"):s.status==="inprogress"?x(s.id,"done"):s.status==="done"&&x(s.id,"todo")},b=new Date(`${s.date}T${s.time}`),y=new Date(b.getTime()+s.duration*6e4).toLocaleTimeString("es-ES",{hour:"2-digit",minute:"2-digit",hourCycle:"h23"}),p=((g=s.subtasks)==null?void 0:g.length)||0,S=((r=s.subtasks)==null?void 0:r.filter(c=>c.isCompleted).length)||0,C={...n,borderWidth:"2px",borderColor:s.status==="inprogress"?v:"transparent",backgroundColor:"#f9fafb"},i={color:"#374151"};return e.jsxs("div",{style:C,onClick:w,className:`absolute rounded-lg p-2 flex gap-2 transition-all duration-300 cursor-pointer ${N}`,children:[e.jsx("div",{className:"flex-shrink-0 w-1 h-full rounded-full",style:{backgroundColor:v}}),e.jsxs("div",{className:"flex-grow flex flex-col min-w-0 min-h-0",children:[e.jsxs("div",{className:"flex-grow overflow-hidden",children:[e.jsx("p",{className:`font-bold text-sm break-words ${s.status==="done"?"line-through":""}`,style:i,children:s.text}),e.jsxs("p",{className:`text-xs ${s.status==="done"?"line-through":""}`,style:i,children:[s.time," - ",y," (",s.duration," min)"]})]}),e.jsxs("div",{className:"flex items-center justify-between mt-1 flex-shrink-0",children:[e.jsx("span",{className:"text-xs font-bold px-2 py-0.5 rounded-full bg-white/60",style:i,children:s.employee}),e.jsxs("div",{className:"flex items-center gap-2",style:i,children:[p>0&&e.jsxs("div",{className:"flex items-center gap-1 text-xs font-semibold",children:[e.jsx(F,{name:"list",size:14}),e.jsxs("span",{children:[S,"/",p]})]}),e.jsx("button",{onClick:c=>{c.stopPropagation(),h(s)},className:"p-1 rounded-full hover:bg-black/10 transition-colors",title:"Editar Tarea",children:e.jsx(F,{name:"pencil",size:14})})]})]})]}),e.jsx("div",{className:"flex-shrink-0",children:e.jsxs("button",{onClick:u,className:"w-6 h-6 rounded-full border-2 flex items-center justify-center transition-all",style:{borderColor:s.status==="done"?"#4ade80":"#9ca3af",backgroundColor:s.status==="done"?"#4ade80":"white"},children:[s.status==="inprogress"&&e.jsx("div",{className:"w-2.5 h-2.5 bg-yellow-500 rounded-full"}),s.status==="done"&&e.jsx(F,{name:"check",size:16,className:"text-white"})]})})]})},Se=({task:s,onClose:x,onUpdateTask:h})=>{var S,C;const[w,n]=l.useState(""),v=i=>{const g=(s.subtasks||[]).map(r=>r.id===i?{...r,isCompleted:!r.isCompleted}:r);h({...s,subtasks:g})},N=()=>{if(w.trim()==="")return;const i={id:`sub-${Date.now()}`,text:w.trim(),isCompleted:!1},g=[...s.subtasks||[],i];h({...s,subtasks:g}),n("")},u=i=>{const g=(s.subtasks||[]).filter(r=>r.id!==i);h({...s,subtasks:g})},b=i=>{i.key==="Enter"&&(i.preventDefault(),N())},k=((S=s.subtasks)==null?void 0:S.filter(i=>i.isCompleted).length)||0,y=((C=s.subtasks)==null?void 0:C.length)||0,p=y>0?k/y*100:0;return e.jsx("div",{className:"absolute inset-0 bg-gray-900/40 z-50 flex justify-center items-center p-4",onClick:x,children:e.jsxs("div",{className:"bg-white rounded-xl shadow-2xl w-full max-w-md flex flex-col",onClick:i=>i.stopPropagation(),children:[e.jsxs("header",{className:"p-4 border-b",children:[e.jsx("h3",{className:"font-bold text-lg text-blue-700",children:s.text}),e.jsxs("p",{className:"text-sm text-gray-500",children:[s.time," - ",s.employee]})]}),e.jsxs("div",{className:"p-4 flex-grow overflow-y-auto max-h-[50vh]",children:[y>0&&e.jsxs("div",{className:"mb-4",children:[e.jsxs("div",{className:"flex justify-between items-center text-sm mb-1",children:[e.jsx("span",{className:"font-semibold text-gray-600",children:"Progreso"}),e.jsxs("span",{children:[k," / ",y]})]}),e.jsx("div",{className:"w-full bg-gray-200 rounded-full h-2.5",children:e.jsx("div",{className:"bg-blue-600 h-2.5 rounded-full",style:{width:`${p}%`}})})]}),e.jsx("div",{className:"space-y-2",children:(s.subtasks||[]).map(i=>e.jsxs("div",{className:"flex items-center gap-3 p-2 bg-gray-50 rounded-md group",children:[e.jsx("input",{type:"checkbox",checked:i.isCompleted,onChange:()=>v(i.id),className:"w-5 h-5 rounded text-blue-600 focus:ring-blue-500 flex-shrink-0"}),e.jsx("span",{className:`flex-grow text-gray-800 ${i.isCompleted?"line-through text-gray-400":""}`,children:i.text}),e.jsx("button",{onClick:()=>u(i.id),className:"p-1 text-gray-400 hover:text-red-600 opacity-0 group-hover:opacity-100 transition-opacity",children:e.jsx(F,{name:"trash-2",size:16})})]},i.id))}),y===0&&e.jsx("p",{className:"text-center text-gray-500 py-6",children:"No hay subtareas. ¡Añade la primera!"})]}),e.jsx("div",{className:"p-4 border-t bg-gray-50 rounded-b-xl",children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{type:"text",value:w,onChange:i=>n(i.target.value),onKeyDown:b,placeholder:"Añadir nueva subtarea...",className:"w-full p-2 border border-gray-300 rounded-md bg-white text-sm focus:ring-2 focus:ring-blue-500"}),e.jsx("button",{onClick:N,className:"py-2 px-4 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 text-sm",children:"Añadir"})]})})]})})},he=120,De=30,Te=({tasks:s,onUpdateStatus:x,onEditTask:h,onUpdateTask:w,users:n})=>{const[v,N]=l.useState(new Date),[u,b]=l.useState(null),k=l.useMemo(()=>n.reduce((r,c)=>(r[c.name]=c.color,r),{}),[n]);l.useEffect(()=>{const r=setInterval(()=>N(new Date),6e4);return()=>clearInterval(r)},[]),l.useEffect(()=>{if(u){const r=s.find(c=>c.id===u.id);b(r||null)}},[s,u]);const y=l.useMemo(()=>{const r={};return s.forEach(c=>{const a=parseInt(c.time.split(":")[0],10);r[a]=!0}),r},[s]),p=l.useMemo(()=>{let r=0;const c=[];for(let a=fe;a<=pe;a++){const d=!!y[a]?he:De;c.push({hour:a,top:r,height:d}),r+=d}return c},[y]),S=p.length>0?p[p.length-1].top+p[p.length-1].height:0,C=r=>{const[c,a]=r.split(":").map(Number),o=p.find(f=>f.hour===c);if(!o)return 0;const d=a/60*o.height;return o.top+d},i=l.useMemo(()=>{const r=[...s].sort((a,o)=>a.time.localeCompare(o.time)||o.duration-a.duration),c=[];for(const a of r){const o=C(a.time),d=new Date(`${a.date}T${a.time}`).getTime(),f=d+a.duration*6e4,E=p.find(D=>D.hour===parseInt(a.time.split(":")[0],10)),L=E?E.height:he,A=a.duration/60*L,P=[];for(const D of c){const M=new Date(`${D.task.date}T${D.task.time}`).getTime(),T=M+D.task.duration*6e4;d<T&&f>M&&P.push(D)}let O=0;for(;P.some(D=>D.left===O);)O++;c.push({task:a,top:o,height:A,left:O,width:1,zIndex:O})}return c.map((a,o,d)=>{const{task:f}=a,E=new Date(`${f.date}T${f.time}`).getTime(),L=E+f.duration*6e4,A=d.filter(T=>{const z=new Date(`${T.task.date}T${T.task.time}`).getTime(),U=z+T.task.duration*6e4;return E<U&&L>z}),P=new Set(A.map(T=>T.left)),O=P.size;let D=0;return D=Array.from(P).sort((T,z)=>T-z).indexOf(a.left),{...a,width:100/O,left:D/O*100}})},[s,p]),g=C(`${v.getHours()}:${v.getMinutes()}`);return e.jsxs("div",{className:"p-4 md:p-6 h-full relative",children:[e.jsxs("div",{className:"relative z-10",style:{height:`${S}px`},children:[p.map(({hour:r,top:c,height:a})=>e.jsxs("div",{className:"absolute w-full",style:{top:`${c}px`,height:`${a}px`},children:[e.jsxs("span",{className:"absolute -top-3 left-0 text-sm font-semibold text-gray-400 w-16 text-right pr-4",children:[r,":00"]}),e.jsx("div",{className:"h-px bg-gray-200 ml-16"})]},r)),g>=0&&g<=S&&e.jsx("div",{className:"absolute left-16 right-0 h-0.5 bg-red-500 z-20",style:{top:`${g}px`},children:e.jsx("div",{className:"absolute -left-1.5 -top-1 w-3 h-3 bg-red-500 rounded-full border-2 border-white"})}),e.jsx("div",{className:"absolute top-0 bottom-0 left-16 right-0",children:i.map(({task:r,top:c,height:a,left:o,width:d,zIndex:f})=>e.jsx(we,{task:r,onUpdateStatus:x,onEdit:h,onViewSubtasks:()=>b(r),userColor:k[r.employee]||"#9ca3af",style:{top:`${c}px`,height:`${Math.max(a-4,80)}px`,left:`${o}%`,width:`calc(${d}% - 4px)`,zIndex:f}},r.id))})]}),u&&e.jsx(Se,{task:u,onClose:()=>b(null),onUpdateTask:w})]})},Ce=s=>s>0?`en ${s} min`:s===0?"¡Ahora!":`hace ${Math.abs(s)} min`,Ee=({tasksWithDiff:s})=>e.jsxs("div",{className:"bg-yellow-100 border-b-2 border-yellow-300 p-3 flex-shrink-0",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[e.jsx(F,{name:"alert-triangle",className:"text-yellow-600",size:20}),e.jsx("h3",{className:"font-bold text-yellow-800 text-base",children:"Tareas Críticas Próximas"})]}),e.jsx("div",{className:"flex gap-4 overflow-x-auto pb-2",children:s.map(({task:x,diff:h})=>e.jsxs("div",{className:"bg-white/70 p-2 rounded-lg border border-yellow-300 flex-shrink-0 w-60",children:[e.jsx("p",{className:"font-bold text-sm text-gray-800 truncate",children:x.text}),e.jsxs("p",{className:`text-xs font-semibold ${h<=0?"text-red-600 animate-pulse":"text-blue-600"}`,children:[x.time," (",Ce(h),")"]})]},x.id))})]}),ke=({isOpen:s,onClose:x,onSelectThisOne:h,onSelectFuture:w,isDelete:n=!1})=>{const N=`¿Qué tareas quieres ${n?"eliminar":"editar"}?`,u=n?"Eliminar solo esta tarea":"Editar solo esta tarea",b="La acción solo se aplicará a esta instancia. El resto de la serie no se verá afectado.",k=n?"Eliminar esta y futuras tareas":"Editar esta y futuras tareas";return e.jsx(xe,{isOpen:s,onClose:x,title:N,children:e.jsxs("div",{className:"flex flex-col gap-4",children:[e.jsxs("button",{onClick:h,className:"p-4 bg-gray-100 rounded-lg border-2 border-transparent hover:border-blue-500 transition-all text-left",children:[e.jsx("h4",{className:"font-bold text-gray-800",children:u}),e.jsx("p",{className:"text-sm text-gray-600 mt-1",children:b})]}),e.jsxs("button",{onClick:w,className:"p-4 bg-gray-100 rounded-lg border-2 border-transparent hover:border-blue-500 transition-all text-left",children:[e.jsx("h4",{className:"font-bold text-gray-800",children:k}),e.jsx("p",{className:"text-sm text-gray-600 mt-1",children:"La acción se aplicará a esta y a todas las repeticiones futuras de la serie."})]}),e.jsx("div",{className:"flex justify-end mt-4",children:e.jsx("button",{type:"button",onClick:x,className:"py-2 px-4 bg-gray-200 text-gray-800 font-semibold rounded-lg hover:bg-gray-300",children:"Cancelar"})})]})})},Oe=({kanbanHook:s,criticalTasks:x,users:h})=>{const{tasks:w,addTask:n,addMultipleTasks:v,updateTask:N,updateTaskStatus:u,deleteTask:b,updateFutureTasks:k,deleteFutureTasks:y}=s,[p,S]=l.useState(new Date),[C,i]=l.useState(!1),[g,r]=l.useState(null),[c,a]=l.useState("All"),[o,d]=l.useState(null),[f,E]=l.useState(null),[L,A]=l.useState("new"),[P,O]=l.useState(null),[D,M]=l.useState(!1),[T,z]=l.useState(""),[U,Y]=l.useState(""),[ae,G]=l.useState(!1),J=t=>{t.recurrenceId?(E("edit"),d(t)):(A("single"),r(t),i(!0))},Z=()=>{i(!1),r(null),A("new")},Q=async(t,m)=>{const{recurrence:H,selectedDays:R,recurrenceWeeks:oe,..._}=t;G(!0);try{if(m&&g)if(L==="future")if(H==="weekly"&&R&&R.length>0){await y(g);const j=new Date(g.date);j.setMinutes(j.getMinutes()+j.getTimezoneOffset());const X=parseInt(oe||"4",10),$=[],W=new Date(j),q=j.getDay(),ue=j.getDate()-q+(q===0?-6:1);W.setDate(ue);for(let B=0;B<X;B++){const K=new Date(W);K.setDate(W.getDate()+B*7),R.forEach(me=>{const se=parseInt(me,10),I=new Date(K);se===0?I.setDate(K.getDate()+6):I.setDate(K.getDate()+(se-1)),I.getTime()>=j.getTime()&&(I.setMinutes(I.getMinutes()-I.getTimezoneOffset()),$.push({..._,date:I.toISOString().split("T")[0]}))})}await v($)}else{const{date:j,time:X,...$}=_;await k(g,$)}else{const{recurrenceId:j,...X}=g,$={...X,..._,id:m};await N($)}else{const j=new Date(_.date);if(j.setMinutes(j.getMinutes()+j.getTimezoneOffset()),H==="weekly"&&R&&R.length>0){const X=parseInt(oe||"4",10),$=[],W=new Date(j),q=j.getDay(),ue=j.getDate()-q+(q===0?-6:1);W.setDate(ue);for(let B=0;B<X;B++){const K=new Date(W);K.setDate(W.getDate()+B*7),R.forEach(me=>{const se=parseInt(me,10),I=new Date(K);se===0?I.setDate(K.getDate()+6):I.setDate(K.getDate()+(se-1)),I.setMinutes(I.getMinutes()-I.getTimezoneOffset()),$.push({..._,date:I.toISOString().split("T")[0]})})}await v($)}else await n(_)}Z()}catch(j){console.error("Error saving task:",j)}finally{G(!1)}},ne=t=>{i(!1),r(null),t.recurrenceId?(E("delete"),d(t)):V(()=>b(t.id))},re=()=>{o&&(A("single"),r(o),i(!0),d(null),E(null))},ie=()=>{o&&(A("future"),r(o),i(!0),d(null),E(null))},le=()=>{o&&(V(()=>{b(o.id)}),d(null),E(null))},ce=()=>{o&&(V(()=>y(o)),d(null),E(null))},V=t=>{O(()=>t),M(!0),z(""),Y("")},de=()=>{T===be?(P==null||P(),M(!1),O(null)):(Y("PIN incorrecto. Inténtalo de nuevo."),z(""))},ee=l.useMemo(()=>{const t=new Date(p);return t.setMinutes(t.getMinutes()-t.getTimezoneOffset()),t.toISOString().split("T")[0]},[p]),te=l.useMemo(()=>w.filter(t=>{const m=t.date===ee,H=c==="All"||t.employee===c;return m&&H}),[w,ee,c]);return e.jsxs("div",{className:"flex flex-col h-full bg-gray-50",children:[x.length>0&&e.jsx(Ee,{tasksWithDiff:x}),e.jsxs("div",{className:"operations-header flex flex-col p-4 border-b border-gray-200 gap-4 flex-shrink-0",children:[e.jsxs("div",{className:"flex flex-col md:flex-row justify-between items-center w-full gap-4",children:[e.jsx(ve,{selectedDate:p,setSelectedDate:S}),e.jsx("div",{className:"flex gap-2 w-full md:w-auto",children:e.jsxs("button",{onClick:()=>{A("new"),r(null),i(!0)},className:"flex items-center gap-2 bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors text-sm w-full justify-center",children:[e.jsx(F,{name:"plus-circle",size:16}),"Añadir Tarea"]})})]}),e.jsxs("div",{className:"flex items-center gap-2 bg-gray-200 rounded-lg p-1 w-full overflow-x-auto",children:[e.jsx("button",{onClick:()=>a("All"),className:`px-3 py-1 text-sm font-bold rounded-md transition-colors ${c==="All"?"bg-white shadow-sm":"bg-transparent text-gray-600"}`,children:"Todos"}),h.map(t=>e.jsx("button",{onClick:()=>a(t.name),className:`px-3 py-1 text-sm font-bold rounded-md transition-colors ${c===t.name?"bg-white shadow-sm":"bg-transparent text-gray-600"}`,children:t.name},t.id))]})]}),e.jsx("div",{className:"flex-grow overflow-auto relative",children:e.jsx(Te,{tasks:te,onEditTask:J,onUpdateStatus:u,onUpdateTask:N,users:h})}),e.jsx(je,{isOpen:C,onClose:Z,onSave:Q,onDelete:ne,task:g,selectedDate:ee,users:h,editMode:L,isSaving:ae,allTasks:w}),e.jsx(ke,{isOpen:!!o,onClose:()=>d(null),onSelectThisOne:f==="edit"?re:le,onSelectFuture:f==="edit"?ie:ce,isDelete:f==="delete"}),D&&e.jsx(xe,{isOpen:D,onClose:()=>M(!1),title:"Confirmar Acción",children:e.jsxs("div",{className:"text-center",children:[e.jsx("h4",{className:"font-bold text-lg text-gray-800",children:"Acción Protegida"}),e.jsx("p",{className:"text-sm text-gray-600 mt-2 mb-4",children:"Para continuar, introduce el PIN de operaciones."}),e.jsx("input",{type:"password",value:T,onChange:t=>{z(t.target.value),Y("")},placeholder:"PIN de Seguridad",autoFocus:!0,className:"w-full p-2 border border-gray-300 rounded-md text-center"}),U&&e.jsx("p",{className:"text-xs text-red-600 mt-1",children:U}),e.jsxs("div",{className:"flex gap-4 mt-4",children:[e.jsx("button",{onClick:()=>M(!1),className:"flex-1 py-2 px-4 bg-gray-200 text-gray-800 font-semibold rounded-lg hover:bg-gray-300",children:"Cancelar"}),e.jsx("button",{onClick:de,className:"flex-1 py-2 px-4 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700",children:"Confirmar"})]})]})})]})};export{Oe as default};
